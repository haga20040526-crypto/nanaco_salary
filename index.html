<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ¦ä¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ (Smart Ver.)</title>
    <style>
        :root { --mcd-red: #DA291C; --mcd-yellow: #FFC72C; --bg-color: #fffbea; --text-dark: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: var(--bg-color); color: var(--text-dark); max-width: 500px; margin: 0 auto; padding-bottom: 80px; }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-top { border-top: 6px solid var(--mcd-red); }
        
        h1 { text-align: center; margin-bottom: 20px; font-size: 1.4rem; color: var(--mcd-red); font-weight: 900; }
        h2 { font-size: 1.1rem; margin-top: 0; border-left: 5px solid var(--mcd-yellow); padding-left: 10px; }
        
        .input-group { margin-bottom: 12px; position: relative; }
        label { display: block; font-weight: bold; font-size: 0.85rem; color: #555; }
        input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; }
        input:focus { border-color: var(--mcd-red); outline: none; }
        
        /* è‡ªå‹•å…¥åŠ›æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        @keyframes flash { 0% { background-color: #fff; } 50% { background-color: #fff3cd; } 100% { background-color: #fff; } }
        .auto-updated { animation: flash 1s ease-out; border-color: var(--mcd-yellow) !important; }

        button { width: 100%; padding: 14px; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: opacity 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--mcd-red); color: var(--mcd-yellow); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-secondary { background-color: #666; color: white; font-size: 0.9rem; padding: 10px; border-radius: 8px; width: auto; display: inline-block; }
        .btn-action { background-color: #007bff; color: white; border-radius: 8px; padding: 10px; font-size: 0.9rem; margin-right: 5px; width: 48%; }
        
        .result-box { margin-top: 20px; background: #fffdf0; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid var(--mcd-yellow); display: none; }
        .total-pay { font-size: 2rem; font-weight: 900; color: var(--mcd-red); }
        
        .dashboard { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: white; padding: 15px; border-radius: 12px; text-align: center; border-bottom: 4px solid var(--mcd-red); }
        .stat-value { font-size: 1.4rem; font-weight: bold; }
        
        .month-item { margin-bottom: 10px; font-size: 0.9rem; }
        .bar-container { background-color: #eee; height: 10px; width: 100%; border-radius: 4px; margin-top: 2px; }
        .bar-fill { background-color: var(--mcd-yellow); height: 100%; border-radius: 4px; }
        .current-month .bar-fill { background-color: var(--mcd-red); }

        .data-area { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #ddd; }
        #fileInput { display: none; }
        
        /* è£œè¶³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .hint-msg { font-size: 0.75rem; color: #888; margin-top: 4px; text-align: right; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="stat-box"><span>ä»Šé€±ã®åˆè¨ˆ</span><br><span class="stat-value" id="weeklyTotal">Â¥0</span></div>
    <div class="stat-box"><span>ä»Šæœˆã®åˆè¨ˆ</span><br><span class="stat-value" id="monthlyTotal">Â¥0</span></div>
</div>

<div class="card card-top">
    <h1>çµ¦ä¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</h1>
    <div class="input-group"><label>åŸºæœ¬æ™‚çµ¦</label><input type="number" id="hourlyWage"></div>
    
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:1;">
            <label>é–‹å§‹</label>
            <input type="time" id="startTime" value="17:00" onchange="autoSuggestBreak()">
        </div>
        <div class="input-group" style="flex:1;">
            <label>çµ‚äº†</label>
            <input type="time" id="endTime" value="23:00" onchange="autoSuggestBreak()">
        </div>
    </div>

    <div class="input-group">
        <label>ä¼‘æ†© (åˆ†)</label>
        <input type="number" id="breakTime" value="45">
        <div class="hint-msg" id="breakHint">å‹¤å‹™æ™‚é–“ã‹ã‚‰è‡ªå‹•ææ¡ˆä¸­</div>
    </div>

    <div class="input-group"><label>æ—¥ä»˜</label><input type="date" id="workDate"></div>
    <button class="btn-primary" onclick="calculateAndSave()">è¨ˆç®—ã—ã¦ä¿å­˜</button>
    
    <div class="result-box" id="resultBox">
        <div>ç™»éŒ²ã—ã¾ã—ãŸ</div><div class="total-pay" id="displayPay">Â¥0</div>
    </div>
</div>

<div class="card">
    <h2>æœˆåˆ¥ãƒ¬ãƒãƒ¼ãƒˆ</h2>
    <div id="monthChartList"></div>
</div>

<div class="card">
    <h2>ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
    <div style="display:flex; justify-content:space-between; margin-top:10px;">
        <button class="btn-action" onclick="downloadBackup()">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
        <button class="btn-action" style="background-color:#28a745;" onclick="document.getElementById('fileInput').click()">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</button>
    </div>
    <input type="file" id="fileInput" accept=".json" onchange="restoreBackup(this)">
    
    <div style="margin-top:20px; text-align:right;">
        <button class="btn-secondary" onclick="fullReset()">âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»</button>
    </div>
</div>

<script>
    // --- è¨­å®š ---
    const APP_PASSWORD = "040802";
    const KEY_DATA = "mcd_app_data_main"; 
    const OLD_KEYS = ["mcd_work_history", "mcd_work_history_v2", "mcd_wage_setting"];
    let appData = { wage: 1100, history: [] };

    // --- åˆæœŸåŒ– ---
    (function init() {
        // â€»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ä½¿ã„ãŸã„å ´åˆã¯ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ( /* ... */ )ã‚’å¤–ã—ã¦ãã ã•ã„
        
        const input = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");
        if (input !== APP_PASSWORD) {
            document.body.innerHTML = "<h1 style='text-align:center;margin-top:50px;'>Locked</h1>";
            return;
        }
        

        loadAndMigrateData();
        
        document.getElementById('hourlyWage').value = appData.wage;
        document.getElementById('workDate').valueAsDate = new Date();
        refreshDashboard();
        
        // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã‚‚ä¼‘æ†©æ™‚é–“ã‚’è¨ˆç®—ã—ã¦ãŠã
        autoSuggestBreak();
    })();

    // --- ä¼‘æ†©æ™‚é–“ã®è‡ªå‹•ææ¡ˆãƒ­ã‚¸ãƒƒã‚¯ ---
    function autoSuggestBreak() {
        const startStr = document.getElementById('startTime').value;
        const endStr = document.getElementById('endTime').value;
        
        if (!startStr || !endStr) return;

        // æ™‚é–“è¨ˆç®—
        const startDate = new Date(`2000-01-01T${startStr}`);
        let endDate = new Date(`2000-01-01T${endStr}`);
        if (endDate < startDate) endDate.setDate(endDate.getDate() + 1);

        const diffMins = (endDate - startDate) / 1000 / 60; // æ‹˜æŸæ™‚é–“(åˆ†)

        // ææ¡ˆãƒ­ã‚¸ãƒƒã‚¯ (åŠ´åƒåŸºæº–æ³•æº–æ‹ )
        // 6æ™‚é–“(360åˆ†)è¶… -> 45åˆ†
        // 8æ™‚é–“(480åˆ†)è¶… -> 60åˆ†
        let suggested = 0;
        if (diffMins > 480) {
            suggested = 60;
        } else if (diffMins > 360) {
            suggested = 45;
        }

        // å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆ & ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§çŸ¥ã‚‰ã›ã‚‹
        const breakInput = document.getElementById('breakTime');
        const currentVal = parseInt(breakInput.value);

        // å€¤ãŒå¤‰æ›´ã«ãªã‚‹å ´åˆã®ã¿æ›´æ–°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰‹å…¥åŠ›ã‚’é‚ªé­”ã—ãªã„é…æ…®ï¼‰
        // ãŸã ã—ã€ä»Šå›ã¯ã€Œæ™‚é–“å¤‰æ›´ï¼ã‚·ãƒ•ãƒˆå¤‰æ›´ã€ã¨ã¿ãªã—ã¦å¸¸ã«å†ææ¡ˆã™ã‚‹ä»•æ§˜ã«ã—ã¾ã™
        breakInput.value = suggested;
        
        // è¦–è¦šçš„ã«ã€Œå¤‰ã‚ã£ãŸã‚ˆï¼ã€ã¨æ•™ãˆã‚‹
        breakInput.classList.remove('auto-updated');
        void breakInput.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼å¼·åˆ¶
        breakInput.classList.add('auto-updated');

        // ãƒ’ãƒ³ãƒˆè¡¨ç¤º
        const hours = Math.floor(diffMins / 60);
        const mins = diffMins % 60;
        document.getElementById('breakHint').innerText = `æ‹˜æŸæ™‚é–“: ${hours}æ™‚é–“${mins}åˆ† â†’ æ³•å®šä¼‘æ†©: ${suggested}åˆ†`;
    }

    // --- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ ---
    function loadAndMigrateData() {
        const savedJSON = localStorage.getItem(KEY_DATA);
        if (savedJSON) {
            appData = JSON.parse(savedJSON);
        } else {
            // æ—§ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
            let foundOldData = false;
            OLD_KEYS.forEach(k => {
                const old = localStorage.getItem(k);
                if (old) {
                    try {
                        const parsed = JSON.parse(old);
                        if (Array.isArray(parsed)) {
                            parsed.forEach(item => {
                                let hItem = item.timestamp ? item : { id: Date.now()+Math.random(), timestamp: new Date().getTime(), pay: item.pay };
                                if(hItem.pay) appData.history.push(hItem);
                            });
                            foundOldData = true;
                        } else if (typeof parsed === 'number' || typeof parsed === 'string') {
                            appData.wage = parseInt(parsed);
                        }
                    } catch(e) {}
                }
            });
            if (foundOldData) saveData();
        }
    }

    function saveData() { localStorage.setItem(KEY_DATA, JSON.stringify(appData)); }

    // --- è¨ˆç®—å®Ÿè¡Œ ---
    function calculateAndSave() {
        const wage = parseInt(document.getElementById('hourlyWage').value);
        const startStr = document.getElementById('startTime').value;
        const endStr = document.getElementById('endTime').value;
        const breakMins = parseInt(document.getElementById('breakTime').value) || 0;
        const dateVal = document.getElementById('workDate').value;

        if (!wage || !startStr || !endStr || !dateVal) { alert("å…¥åŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); return; }

        appData.wage = wage;

        const startDate = new Date(`${dateVal}T${startStr}`);
        let endDate = new Date(`${dateVal}T${endStr}`);
        if (endDate < startDate) endDate.setDate(endDate.getDate() + 1);

        const totalDurationMins = (endDate - startDate) / 1000 / 60;
        
        // æ·±å¤œãƒ»é€šå¸¸è¨ˆç®—
        let totalLate = 0;
        let totalNormal = 0;
        let current = new Date(startDate);
        for (let i = 0; i < totalDurationMins; i++) {
            const h = current.getHours();
            if (h >= 22 || h < 5) totalLate++; else totalNormal++;
            current.setMinutes(current.getMinutes() + 1);
        }

        let remainingBreak = breakMins;
        if (totalNormal >= remainingBreak) { totalNormal -= remainingBreak; remainingBreak = 0; }
        else { remainingBreak -= totalNormal; totalNormal = 0; }
        if (remainingBreak > 0) totalLate -= remainingBreak;
        if (totalLate < 0) totalLate = 0;

        const normalPay = Math.floor(wage * (totalNormal / 60));
        const latePay = Math.floor(Math.floor(wage * 1.25) * (totalLate / 60));
        const totalPay = normalPay + latePay;

        appData.history.push({ id: Date.now(), timestamp: startDate.getTime(), pay: totalPay });
        saveData();

        document.getElementById('resultBox').style.display = 'block';
        document.getElementById('displayPay').innerText = `Â¥${totalPay.toLocaleString()}`;
        refreshDashboard();
    }

    function refreshDashboard() {
        const now = new Date();
        let weekTotal = 0;
        let monthTotal = 0;
        const monthlyStats = {};

        const startOfWeek = new Date(now);
        startOfWeek.setHours(0,0,0,0);
        startOfWeek.setDate(now.getDate() - now.getDay());

        appData.history.forEach(item => {
            const d = new Date(item.timestamp);
            if (d >= startOfWeek) weekTotal += item.pay;
            if (d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth()) monthTotal += item.pay;

            const key = `${d.getFullYear()}-${d.getMonth()+1}`;
            if (!monthlyStats[key]) monthlyStats[key] = 0;
            monthlyStats[key] += item.pay;
        });

        document.getElementById('weeklyTotal').innerText = `Â¥${weekTotal.toLocaleString()}`;
        document.getElementById('monthlyTotal').innerText = `Â¥${monthTotal.toLocaleString()}`;

        const chartHtml = Object.keys(monthlyStats).sort().reverse().map(key => {
            const max = Math.max(...Object.values(monthlyStats));
            const percent = (monthlyStats[key] / max) * 100;
            const isCurrent = key === `${now.getFullYear()}-${now.getMonth()+1}`;
            return `<div class="month-item ${isCurrent ? 'current-month' : ''}">
                <div style="display:flex; justify-content:space-between;">
                    <span>${key}æœˆ</span><span>Â¥${monthlyStats[key].toLocaleString()}</span>
                </div>
                <div class="bar-container"><div class="bar-fill" style="width:${percent}%"></div></div>
            </div>`;
        }).join('');
        document.getElementById('monthChartList').innerHTML = chartHtml || "<div style='text-align:center;color:#999'>å±¥æ­´ãªã—</div>";
    }

    function downloadBackup() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(appData)], {type: "application/json"}));
        a.download = `mcd_salary_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function restoreBackup(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loaded = JSON.parse(e.target.result);
                if (loaded.wage && Array.isArray(loaded.history)) {
                    if(confirm("å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) { appData = loaded; saveData(); refreshDashboard(); alert("å®Œäº†"); }
                } else alert("ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒé•ã„ã¾ã™");
            } catch(e) { alert("ã‚¨ãƒ©ãƒ¼"); }
        };
        reader.readAsText(file);
    }

    function fullReset() {
        if(confirm("æœ¬å½“ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem(KEY_DATA); location.reload(); }
    }
</script>
</body>
</html>
