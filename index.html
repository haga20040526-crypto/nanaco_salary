<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ¦ä¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ (Safe Ver.)</title>
    <style>
        :root { --mcd-red: #DA291C; --mcd-yellow: #FFC72C; --bg-color: #fffbea; --text-dark: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: var(--bg-color); color: var(--text-dark); max-width: 500px; margin: 0 auto; padding-bottom: 80px; }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-top { border-top: 6px solid var(--mcd-red); }
        
        h1 { text-align: center; margin-bottom: 20px; font-size: 1.4rem; color: var(--mcd-red); font-weight: 900; }
        h2 { font-size: 1.1rem; margin-top: 0; border-left: 5px solid var(--mcd-yellow); padding-left: 10px; }
        
        .input-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; font-size: 0.85rem; color: #555; }
        input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: opacity 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--mcd-red); color: var(--mcd-yellow); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-secondary { background-color: #666; color: white; font-size: 0.9rem; padding: 10px; border-radius: 8px; width: auto; display: inline-block; }
        .btn-action { background-color: #007bff; color: white; border-radius: 8px; padding: 10px; font-size: 0.9rem; margin-right: 5px; width: 48%; }
        
        .result-box { margin-top: 20px; background: #fffdf0; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid var(--mcd-yellow); display: none; }
        .total-pay { font-size: 2rem; font-weight: 900; color: var(--mcd-red); }
        
        .dashboard { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: white; padding: 15px; border-radius: 12px; text-align: center; border-bottom: 4px solid var(--mcd-red); }
        .stat-value { font-size: 1.4rem; font-weight: bold; }
        
        .month-item { margin-bottom: 10px; font-size: 0.9rem; }
        .bar-container { background-color: #eee; height: 10px; width: 100%; border-radius: 4px; margin-top: 2px; }
        .bar-fill { background-color: var(--mcd-yellow); height: 100%; border-radius: 4px; }
        .current-month .bar-fill { background-color: var(--mcd-red); }

        /* ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚¨ãƒªã‚¢ */
        .data-area { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #ddd; }
        #fileInput { display: none; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="stat-box"><span>ä»Šé€±ã®åˆè¨ˆ</span><br><span class="stat-value" id="weeklyTotal">Â¥0</span></div>
    <div class="stat-box"><span>ä»Šæœˆã®åˆè¨ˆ</span><br><span class="stat-value" id="monthlyTotal">Â¥0</span></div>
</div>

<div class="card card-top">
    <h1>çµ¦ä¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</h1>
    <div class="input-group"><label>åŸºæœ¬æ™‚çµ¦</label><input type="number" id="hourlyWage"></div>
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:1;"><label>é–‹å§‹</label><input type="time" id="startTime" value="17:00"></div>
        <div class="input-group" style="flex:1;"><label>çµ‚äº†</label><input type="time" id="endTime" value="23:00"></div>
    </div>
    <div class="input-group"><label>ä¼‘æ†© (åˆ†)</label><input type="number" id="breakTime" value="45"></div>
    <div class="input-group"><label>æ—¥ä»˜</label><input type="date" id="workDate"></div>
    <button class="btn-primary" onclick="calculateAndSave()">è¨ˆç®—ã—ã¦ä¿å­˜</button>
    
    <div class="result-box" id="resultBox">
        <div>ç™»éŒ²ã—ã¾ã—ãŸ</div><div class="total-pay" id="displayPay">Â¥0</div>
    </div>
</div>

<div class="card">
    <h2>æœˆåˆ¥ãƒ¬ãƒãƒ¼ãƒˆ</h2>
    <div id="monthChartList"></div>
</div>

<div class="card">
    <h2>ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
    <p style="font-size:0.8rem; color:#666; margin-top:0;">
        æ©Ÿç¨®å¤‰æ›´ã‚„ãƒ‡ãƒ¼ã‚¿æ¶ˆå»ã«å‚™ãˆã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã§ãã¾ã™ã€‚
    </p>
    <div style="display:flex; justify-content:space-between; margin-top:10px;">
        <button class="btn-action" onclick="downloadBackup()">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
        <button class="btn-action" style="background-color:#28a745;" onclick="document.getElementById('fileInput').click()">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</button>
    </div>
    <input type="file" id="fileInput" accept=".json" onchange="restoreBackup(this)">
    
    <div style="margin-top:20px; text-align:right;">
        <button class="btn-secondary" onclick="fullReset()">âš ï¸ å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»</button>
    </div>
</div>

<script>
    // å®šæ•°è¨­å®š
    const APP_PASSWORD = "0107";
    // çµ±ä¸€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ï¼ˆä»Šå¾Œã¯ã“ã‚Œã‚’ä½¿ã„ç¶šã‘ã‚‹ï¼‰
    const KEY_DATA = "mcd_app_data_main"; 
    // éå»ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚­ãƒ¼ï¼ˆç§»è¡Œç”¨ï¼‰
    const OLD_KEYS = ["mcd_work_history", "mcd_work_history_v2", "mcd_wage_setting"];

    // ã‚¢ãƒ—ãƒªçŠ¶æ…‹ç®¡ç†
    let appData = {
        wage: 1100,
        history: []
    };

    // --- åˆæœŸåŒ–å‡¦ç† ---
    (function init() {
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆä¸è¦ãªã‚‰ã“ã®ifæ–‡ã‚’å¤–ã—ã¦ãã ã•ã„ï¼‰
        /*
        const input = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›");
        if (input !== APP_PASSWORD) {
            document.body.innerHTML = "<h1 style='text-align:center;margin-top:50px;'>Locked</h1>";
            return;
        }
        */

        // 1. ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ & ç§»è¡Œãƒã‚§ãƒƒã‚¯
        loadAndMigrateData();
        
        // 2. ç”»é¢ã¸ã®åæ˜ 
        document.getElementById('hourlyWage').value = appData.wage;
        document.getElementById('workDate').valueAsDate = new Date();
        refreshDashboard();
    })();

    // --- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯ (æœ€é‡è¦) ---
    function loadAndMigrateData() {
        // ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const savedJSON = localStorage.getItem(KEY_DATA);

        if (savedJSON) {
            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼šãã®ã¾ã¾ä½¿ã†
            appData = JSON.parse(savedJSON);
        } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼šå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ã—ã¦ç§»è¡Œã™ã‚‹
            console.log("ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚æ—§ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œã‚’è©¦ã¿ã¾ã™...");
            let foundOldData = false;

            // ver 1, 2 ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’æ¢ã™
            OLD_KEYS.forEach(k => {
                const old = localStorage.getItem(k);
                if (old) {
                    try {
                        const parsed = JSON.parse(old);
                        if (Array.isArray(parsed)) {
                            // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®å ´åˆ
                            // å¤ã„ãƒ‡ãƒ¼ã‚¿å½¢å¼(v1)ã‹æ–°ã—ã„å½¢å¼(v2)ã‹åˆ¤åˆ¥ã—ã¦æ•´å½¢
                            parsed.forEach(item => {
                                let historyItem = {};
                                if (item.timestamp) { // v2å½¢å¼
                                    historyItem = item;
                                } else if (item.date) { // v1å½¢å¼ (æ—¥ä»˜æ–‡å­—åˆ—ã—ã‹ãªã„å ´åˆ)
                                    // ç¾åœ¨å¹´ã‚’è£œå®Œã—ã¦timestampã‚’ä½œã‚‹ç°¡æ˜“å¯¾å¿œ
                                    const d = new Date(item.date); // ã“ã‚Œã ã¨æ­£ç¢ºãªæ—¥ä»˜ã«ãªã‚‰ãªã„å¯èƒ½æ€§ã‚ã‚Š
                                    historyItem = {
                                        id: Date.now() + Math.random(),
                                        timestamp: new Date().getTime(), // æ­£ç¢ºãªå¾©å…ƒã¯é›£ã—ã„ã®ã§ç¾åœ¨æ™‚åˆ»ç­‰ã«ã™ã‚‹ã‹ã‚¹ã‚­ãƒƒãƒ—
                                        pay: item.pay
                                    };
                                }
                                if(historyItem.pay) appData.history.push(historyItem);
                            });
                            foundOldData = true;
                        } else if (typeof parsed === 'number' || typeof parsed === 'string') {
                            // æ™‚çµ¦è¨­å®šã®å ´åˆ
                            appData.wage = parseInt(parsed);
                        }
                    } catch(e) { console.error("ç§»è¡Œã‚¨ãƒ©ãƒ¼", e); }
                }
            });

            if (foundOldData) {
                alert("ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚è‡ªå‹•ã§å¼•ãç¶™ãã¾ã—ãŸï¼");
                saveData(); // æ–°ã—ã„å½¢å¼ã§ä¿å­˜ã—ç›´ã™
            }
        }
    }

    function saveData() {
        localStorage.setItem(KEY_DATA, JSON.stringify(appData));
    }

    // --- è¨ˆç®—å‡¦ç† ---
    function calculateAndSave() {
        const wage = parseInt(document.getElementById('hourlyWage').value);
        const startStr = document.getElementById('startTime').value;
        const endStr = document.getElementById('endTime').value;
        const breakMins = parseInt(document.getElementById('breakTime').value) || 0;
        const dateVal = document.getElementById('workDate').value;

        if (!wage || !startStr || !endStr || !dateVal) { alert("å…¥åŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); return; }

        appData.wage = wage; // æ™‚çµ¦ã‚’æ›´æ–°

        const startDate = new Date(`${dateVal}T${startStr}`);
        let endDate = new Date(`${dateVal}T${endStr}`);
        if (endDate < startDate) endDate.setDate(endDate.getDate() + 1);

        const totalDurationMins = (endDate - startDate) / 1000 / 60;
        
        let totalLate = 0;
        let totalNormal = 0;
        let current = new Date(startDate);
        for (let i = 0; i < totalDurationMins; i++) {
            const h = current.getHours();
            if (h >= 22 || h < 5) totalLate++; else totalNormal++;
            current.setMinutes(current.getMinutes() + 1);
        }

        let remainingBreak = breakMins;
        if (totalNormal >= remainingBreak) { totalNormal -= remainingBreak; remainingBreak = 0; }
        else { remainingBreak -= totalNormal; totalNormal = 0; }
        if (remainingBreak > 0) totalLate -= remainingBreak;
        if (totalLate < 0) totalLate = 0;

        const normalPay = Math.floor(wage * (totalNormal / 60));
        const latePay = Math.floor(Math.floor(wage * 1.25) * (totalLate / 60));
        const totalPay = normalPay + latePay;

        // ä¿å­˜
        appData.history.push({
            id: Date.now(),
            timestamp: startDate.getTime(),
            pay: totalPay
        });
        saveData();

        // è¡¨ç¤º
