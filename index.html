<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ¦ä¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ (Graph Ver.)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --mcd-red: #DA291C; --mcd-yellow: #FFC72C; --bg-color: #fffbea; --text-dark: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: var(--bg-color); color: var(--text-dark); max-width: 500px; margin: 0 auto; padding-bottom: 80px; }
        
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-top { border-top: 6px solid var(--mcd-red); }
        
        h1 { text-align: center; margin-bottom: 20px; font-size: 1.4rem; color: var(--mcd-red); font-weight: 900; }
        h2 { font-size: 1.1rem; margin-top: 0; border-left: 5px solid var(--mcd-yellow); padding-left: 10px; display: flex; justify-content: space-between; align-items: center;}
        
        .input-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; font-size: 0.85rem; color: #555; }
        input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; }
        input:focus { border-color: var(--mcd-red); outline: none; }
        
        @keyframes flash { 0% { background-color: #fff; } 50% { background-color: #fff3cd; } 100% { background-color: #fff; } }
        .auto-updated { animation: flash 1s ease-out; border-color: var(--mcd-yellow) !important; }

        button { width: 100%; padding: 14px; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: opacity 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-primary { background-color: var(--mcd-red); color: var(--mcd-yellow); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-secondary { background-color: #666; color: white; font-size: 0.9rem; padding: 10px; border-radius: 8px; width: auto; display: inline-block; }
        .btn-action { background-color: #007bff; color: white; border-radius: 8px; padding: 10px; font-size: 0.9rem; margin-right: 5px; width: 48%; }
        
        .result-box { margin-top: 20px; background: #fffdf0; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid var(--mcd-yellow); display: none; }
        .total-pay { font-size: 2rem; font-weight: 900; color: var(--mcd-red); }
        
        .dashboard { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: white; padding: 15px; border-radius: 12px; text-align: center; border-bottom: 4px solid var(--mcd-red); }
        .stat-value { font-size: 1.4rem; font-weight: bold; }
        
        /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ */
        .log-month-group { margin-bottom: 20px; }
        .log-month-title { font-size: 0.9rem; font-weight: bold; color: #666; background: #eee; padding: 5px 10px; border-radius: 4px; margin-bottom: 10px; }
        .log-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding: 10px 0; }
        .log-left { flex: 1; }
        .log-date { font-weight: bold; font-size: 0.95rem; display: block; }
        .log-time { font-size: 0.8rem; color: #888; display: block; margin-top: 2px;}
        .log-right { text-align: right; }
        .log-pay { font-weight: bold; color: var(--mcd-red); font-size: 1.1rem; }
        .log-delete { background: none; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer; padding: 0 0 0 10px; width: auto; margin: 0; }
        .log-delete:hover { color: red; }

        .data-area { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #ddd; }
        #fileInput { display: none; }
        .hint-msg { font-size: 0.75rem; color: #888; margin-top: 4px; text-align: right; }

        /* ã‚°ãƒ©ãƒ•ç”¨ã‚³ãƒ³ãƒ†ãƒŠ */
        .chart-container { position: relative; height: 250px; width: 100%; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="stat-box"><span>ä»Šé€±</span><br><span class="stat-value" id="weeklyTotal">Â¥0</span></div>
    <div class="stat-box"><span>ä»Šæœˆ</span><br><span class="stat-value" id="monthlyTotal">Â¥0</span></div>
</div>

<div class="card card-top">
    <h1>çµ¦ä¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</h1>
    <div class="input-group"><label>åŸºæœ¬æ™‚çµ¦</label><input type="number" id="hourlyWage"></div>
    
    <div style="display:flex; gap:10px;">
        <div class="input-group" style="flex:1;">
            <label>é–‹å§‹</label>
            <input type="time" id="startTime" value="17:00" onchange="autoSuggestBreak()">
        </div>
        <div class="input-group" style="flex:1;">
            <label>çµ‚äº†</label>
            <input type="time" id="endTime" value="23:00" onchange="autoSuggestBreak()">
        </div>
    </div>

    <div class="input-group">
        <label>ä¼‘æ†© (åˆ†)</label>
        <input type="number" id="breakTime" value="45">
        <div class="hint-msg" id="breakHint"></div>
    </div>

    <div class="input-group"><label>æ—¥ä»˜</label><input type="date" id="workDate"></div>
    <button class="btn-primary" onclick="calculateAndSave()">è¨ˆç®—ã—ã¦ä¿å­˜</button>
    
    <div class="result-box" id="resultBox">
        <div>ç™»éŒ²ã—ã¾ã—ãŸ</div><div class="total-pay" id="displayPay">Â¥0</div>
    </div>
</div>

<div class="card">
    <h2>æœˆåˆ¥æ¨ç§»ã‚°ãƒ©ãƒ• ğŸ“ˆ</h2>
    <div class="chart-container">
        <canvas id="salaryChart"></canvas>
    </div>
</div>

<div class="card">
    <h2>å‹¤å‹™æ˜ç´° ğŸ“</h2>
    <div id="workLogList"></div>
</div>

<div class="card">
    <h2>è¨­å®šãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
    <div style="display:flex; justify-content:space-between; margin-top:10px;">
        <button class="btn-action" onclick="downloadBackup()">ğŸ’¾ ä¿å­˜</button>
        <button class="btn-action" style="background-color:#28a745;" onclick="document.getElementById('fileInput').click()">ğŸ“‚ å¾©å…ƒ</button>
    </div>
    <input type="file" id="fileInput" accept=".json" onchange="restoreBackup(this)">
    <div style="margin-top:20px; text-align:right;">
        <button class="btn-secondary" onclick="fullReset()">âš ï¸ å…¨å‰Šé™¤</button>
    </div>
</div>

<script>
    const KEY_DATA = "mcd_app_data_main"; 
    const OLD_KEYS = ["mcd_work_history", "mcd_work_history_v2", "mcd_wage_setting"];
    let appData = { wage: 1100, history: [] };
    let myChart = null; // ã‚°ãƒ©ãƒ•ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä¿æŒç”¨

    (function init() {
        loadAndMigrateData();
        document.getElementById('hourlyWage').value = appData.wage;
        document.getElementById('workDate').valueAsDate = new Date();
        refreshAll();
        autoSuggestBreak();
    })();

    // --- ä¼‘æ†©ææ¡ˆ (6æ™‚é–“è¶…=60åˆ†) ---
    function autoSuggestBreak() {
        const startStr = document.getElementById('startTime').value;
        const endStr = document.getElementById('endTime').value;
        if (!startStr || !endStr) return;

        const startDate = new Date(`2000-01-01T${startStr}`);
        let endDate = new Date(`2000-01-01T${endStr}`);
        if (endDate < startDate) endDate.setDate(endDate.getDate() + 1);

        const diffMins = (endDate - startDate) / 1000 / 60;
        let suggested = 0;
        if (diffMins > 360) suggested = 60; // 6æ™‚é–“è¶…ã§60åˆ†

        const breakInput = document.getElementById('breakTime');
        breakInput.value = suggested;
        
        breakInput.classList.remove('auto-updated');
        void breakInput.offsetWidth;
        breakInput.classList.add('auto-updated');

        const h = Math.floor(diffMins / 60);
        const m = diffMins % 60;
        document.getElementById('breakHint').innerText = `æ‹˜æŸ: ${h}æ™‚é–“${m}åˆ† â†’ è‡ªå‹•ææ¡ˆ: ${suggested}åˆ†`;
    }

    function loadAndMigrateData() {
        const savedJSON = localStorage.getItem(KEY_DATA);
        if (savedJSON) {
            appData = JSON.parse(savedJSON);
        } else {
            let found = false;
            OLD_KEYS.forEach(k => {
                const old = localStorage.getItem(k);
                if (old) {
                    try {
                        const parsed = JSON.parse(old);
                        if (Array.isArray(parsed)) {
                            parsed.forEach(item => {
                                let hItem = item.timestamp ? item : { id: Date.now()+Math.random(), timestamp: new Date().getTime(), pay: item.pay };
                                if(hItem.pay) appData.history.push(hItem);
                            });
                            found = true;
                        } else if (typeof parsed === 'number' || typeof parsed === 'string') {
                            appData.wage = parseInt(parsed);
                        }
                    } catch(e) {}
                }
            });
            if (found) saveData();
        }
    }

    function saveData() { localStorage.setItem(KEY_DATA, JSON.stringify(appData)); }

    function calculateAndSave() {
        const wage = parseInt(document.getElementById('hourlyWage').value);
        const startStr = document.getElementById('startTime').value;
        const endStr = document.getElementById('endTime').value;
        const breakMins = parseInt(document.getElementById('breakTime').value) || 0;
        const dateVal = document.getElementById('workDate').value;

        if (!wage || !startStr || !endStr || !dateVal) { alert("å…¥åŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); return; }

        appData.wage = wage;

        const startDate = new Date(`${dateVal}T${startStr}`);
        let endDate = new Date(`${dateVal}T${endStr}`);
        if (endDate < startDate) endDate.setDate(endDate.getDate() + 1);

        const totalDurationMins = (endDate - startDate) / 1000 / 60;
        
        let totalLate = 0;
        let totalNormal = 0;
        let current = new Date(startDate);
        for (let i = 0; i < totalDurationMins; i++) {
            const h = current.getHours();
            if (h >= 22 || h < 5) totalLate++; else totalNormal++;
            current.setMinutes(current.getMinutes() + 1);
        }

        let remainingBreak = breakMins;
        if (totalNormal >= remainingBreak) { totalNormal -= remainingBreak; remainingBreak = 0; }
        else { remainingBreak -= totalNormal; totalNormal = 0; }
        if (remainingBreak > 0) totalLate -= remainingBreak;
        if (totalLate < 0) totalLate = 0;

        const normalPay = Math.floor(wage * (totalNormal / 60));
        const latePay = Math.floor(Math.floor(wage * 1.25) * (totalLate / 60));
        const totalPay = normalPay + latePay;

        appData.history.push({ 
            id: Date.now(), 
            timestamp: startDate.getTime(), 
            pay: totalPay,
            timeRange: `${startStr} - ${endStr}`, 
            breakMins: breakMins 
        });
        saveData();

        document.getElementById('resultBox').style.display = 'block';
        document.getElementById('displayPay').innerText = `Â¥${totalPay.toLocaleString()}`;
        refreshAll();
    }

    function deleteItem(id) {
        if(confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            appData.history = appData.history.filter(item => item.id !== id);
            saveData();
            refreshAll();
        }
    }

    function refreshAll() {
        refreshDashboard();
        renderWorkLog();
        renderChart(); // ã‚°ãƒ©ãƒ•æç”»
    }

    function refreshDashboard() {
        const now = new Date();
        let weekTotal = 0;
        let monthTotal = 0;

        const startOfWeek = new Date(now);
        startOfWeek.setHours(0,0,0,0);
        startOfWeek.setDate(now.getDate() - now.getDay());

        appData.history.forEach(item => {
            const d = new Date(item.timestamp);
            if (d >= startOfWeek) weekTotal += item.pay;
            if (d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth()) monthTotal += item.pay;
        });

        document.getElementById('weeklyTotal').innerText = `Â¥${weekTotal.toLocaleString()}`;
        document.getElementById('monthlyTotal').innerText = `Â¥${monthTotal.toLocaleString()}`;
    }

    function renderWorkLog() {
        const logContainer = document.getElementById('workLogList');
        logContainer.innerHTML = "";
        const sortedHistory = [...appData.history].sort((a, b) => b.timestamp - a.timestamp);

        if (sortedHistory.length === 0) {
            logContainer.innerHTML = "<div style='text-align:center; color:#999;'>ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>";
            return;
        }

        const grouped = {};
        sortedHistory.forEach(item => {
            const d = new Date(item.timestamp);
            const monthKey = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`;
            if (!grouped[monthKey]) grouped[monthKey] = [];
            grouped[monthKey].push(item);
        });

        Object.keys(grouped).forEach(key => {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'log-month-group';
            groupDiv.innerHTML = `<div class="log-month-title">${key}</div>`;

            grouped[key].forEach(item => {
                const d = new Date(item.timestamp);
                const dateStr = `${d.getDate()}æ—¥ (${["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"][d.getDay()]})`;
                const timeInfo = item.timeRange ? `${item.timeRange} (ä¼‘${item.breakMins}åˆ†)` : '<span style="font-size:0.7rem; color:#ccc;">æ™‚é–“è©³ç´°ãªã—</span>';
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'log-item';
                itemDiv.innerHTML = `
                    <div class="log-left">
                        <span class="log-date">${dateStr}</span>
                        <span class="log-time">${timeInfo}</span>
                    </div>
                    <div class="log-right">
                        <span class="log-pay">Â¥${item.pay.toLocaleString()}</span>
                    </div>
                    <button class="log-delete" onclick="deleteItem(${item.id})">ğŸ—‘ï¸</button>
                `;
                groupDiv.appendChild(itemDiv);
            });
            logContainer.appendChild(groupDiv);
        });
    }

    // --- Chart.jsã‚’ä½¿ã£ãŸã‚°ãƒ©ãƒ•æç”» ---
    function renderChart() {
        // é›†è¨ˆå‡¦ç†
        const monthlyStats = {};
        appData.history.forEach(item => {
            const d = new Date(item.timestamp);
            const key = `${d.getFullYear()}-${d.getMonth()+1}`; // 2024-5 ã®ã‚ˆã†ãªã‚­ãƒ¼
            if (!monthlyStats[key]) monthlyStats[key] = 0;
            monthlyStats[key] += item.pay;
        });

        // ã‚°ãƒ©ãƒ•ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ (æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ)
        const sortedKeys = Object.keys(monthlyStats).sort((a, b) => {
            return new Date(a) - new Date(b);
        });

        const labels = sortedKeys.map(k => {
            const [y, m] = k.split('-');
            return `${m}æœˆ`; // Xè»¸ã®ãƒ©ãƒ™ãƒ«
        });
        const dataValues = sortedKeys.map(k => monthlyStats[k]);

        // æ—¢å­˜ã®ã‚°ãƒ©ãƒ•ãŒã‚ã‚Œã°å‰Šé™¤ (å†æç”»ã®ãŸã‚)
        if (myChart) {
            myChart.destroy();
        }

        // ã‚°ãƒ©ãƒ•æç”»
        const ctx = document.getElementById('salaryChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'çµ¦ä¸ (å††)',
                    data: dataValues,
                    backgroundColor: 'rgba(218, 41, 28, 0.7)', // ãƒãƒƒã‚¯èµ¤
                    borderColor: 'rgba(255, 199, 44, 1)', // ãƒãƒƒã‚¯é»„
                    borderWidth: 2,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'Â¥' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    legend: { display: false } // å‡¡ä¾‹ã¯æ¶ˆã™
                }
            }
        });
    }

    function downloadBackup() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(appData)], {type: "application/json"}));
        a.download = `mcd_salary_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
    }

    function restoreBackup(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const loaded = JSON.parse(e.target.result);
                if (loaded.wage && Array.isArray(loaded.history)) {
                    if(confirm("å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) { appData = loaded; saveData(); refreshAll(); alert("å®Œäº†"); }
                } else alert("ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒé•ã„ã¾ã™");
            } catch(e) { alert("ã‚¨ãƒ©ãƒ¼"); }
        };
        reader.readAsText(file);
    }

    function fullReset() {
        if(confirm("æœ¬å½“ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { localStorage.removeItem(KEY_DATA); location.reload(); }
    }
</script>
</body>
</html>
